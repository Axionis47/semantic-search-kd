# =============================================================================
# Docker Compose for Semantic Search with Knowledge Distillation
# =============================================================================
#
# Services:
# - api: Main semantic search API
# - prometheus: Metrics collection (optional)
# - grafana: Metrics visualization (optional)
#
# Usage:
#   docker-compose up -d          # Start all services
#   docker-compose up api         # Start API only
#   docker-compose logs -f api    # View API logs
#   docker-compose down           # Stop all services
#
# =============================================================================

version: "3.8"

services:
  # ---------------------------------------------------------------------------
  # Main API Service
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: semantic-kd:latest
    container_name: semantic-kd-api
    ports:
      - "8080:8080"
    environment:
      - SEMANTIC_KD_ENVIRONMENT=development
      - SEMANTIC_KD_DEBUG=true
      - SEMANTIC_KD_SERVICE__PORT=8080
      - SEMANTIC_KD_SERVICE__LOG_LEVEL=info
      - SEMANTIC_KD_SERVICE__CORS__ALLOW_ORIGINS=["http://localhost:3000","http://localhost:8080"]
      - SEMANTIC_KD_SERVICE__RATE_LIMIT__ENABLED=true
      - SEMANTIC_KD_SERVICE__AUTH__ENABLED=false
    volumes:
      # Mount model artifacts
      - ./artifacts/models:/app/artifacts/models:ro
      # Mount index files
      - ./artifacts/indexes:/app/artifacts/indexes:ro
      # Mount data (if needed for index building)
      - ./data:/app/data:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - semantic-kd-network

  # ---------------------------------------------------------------------------
  # Prometheus (Optional - for metrics)
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: semantic-kd-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./infra/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
    restart: unless-stopped
    networks:
      - semantic-kd-network
    profiles:
      - monitoring

  # ---------------------------------------------------------------------------
  # Grafana (Optional - for visualization)
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:10.1.0
    container_name: semantic-kd-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:?Set GRAFANA_ADMIN_PASSWORD in .env}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infra/grafana/provisioning:/etc/grafana/provisioning:ro
    restart: unless-stopped
    networks:
      - semantic-kd-network
    depends_on:
      - prometheus
    profiles:
      - monitoring

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  semantic-kd-network:
    driver: bridge

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  prometheus_data:
  grafana_data:
